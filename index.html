<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Assist Copilot</title>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            margin: 0;
        }
        .scanner-section {
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ccc;
            text-align: center;
        }
        #qr-reader {
            width: 500px;
            margin: auto;
            border: 1px solid #ccc;
        }
        .copilot-section {
            flex-grow: 1; 
        }
        iframe { 
            border: none; 
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <div class="scanner-section">
        <button id="start-scan-btn">Scan Equipment QR Code</button>
        <div id="qr-reader" style="display: none;"></div>
        <h3>Scanned Result: <span id="scanned-result"></span></h3>
    </div>

    <div class="copilot-section">
        <iframe id="copilot-iframe" src="https://copilotstudio.microsoft.com/environments/5d328100-505d-e5c7-9dd9-45b818f1b5f1/bots/cr72e_aiManualAssistCopilot_Nmq8jI/webchat?__version__=2"></iframe>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
        const startScanButton = document.getElementById('start-scan-btn');
        const qrReaderDiv = document.getElementById('qr-reader');
        const resultSpan = document.getElementById('scanned-result');
        const copilotIframe = document.getElementById('copilot-iframe');
        let html5QrcodeScanner;
        
        // --- NEW, MORE RELIABLE LOGIC ---

        // This function will be called when the scanner is successful
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            resultSpan.innerHTML = decodedText; // Show result on page

            // Construct the message to send to the bot
            const messageToSend = "search by equipment number " + decodedText;
            
            // Create the specific activity object that Copilot Studio expects
            const activity = {
                from: { id: 'user', name: 'User', role: 'user' },
                type: 'message',
                text: messageToSend
            };

            // Send the activity to the iframe
            copilotIframe.contentWindow.postMessage({
                type: 'POST_ACTIVITY',
                payload: { activity: activity }
            }, 'https://copilotstudio.microsoft.com'); // Use the correct target origin for security
            
            // Stop and hide the scanner
            html5QrcodeScanner.clear().catch(error => {
                console.error("Failed to clear html5QrcodeScanner.", error);
            });
            qrReaderDiv.style.display = 'none';
        }

        function onScanError(errorMessage) {
            // handle scan error, usually we can ignore this.
        }

        // This function runs when the user clicks the scan button
        startScanButton.addEventListener('click', () => {
            qrReaderDiv.style.display = 'block';
            
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "qr-reader", 
                    { fps: 10, qrbox: { width: 250, height: 250 } }
                );
            }
            
            html5QrcodeScanner.render(onScanSuccess, onScanError);
        });

    </script>

</body>
</html>
